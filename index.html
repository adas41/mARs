<!DOCTYPE html>
<html lang="en">
	<meta charset="UTF-8"></meta>
	<title>mARs: Mobile Augmented Reality Search</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
	<head>
		<script src="http://connect.facebook.net/en_US/all.js"></script>
		<script type="text/javascript" src="./assets/js/jquery.1.9.js"></script>
	</head>
	
	<body>


		<!-- Facebook login -->
			<div id="fb-root"></div>
			<script>
			  // Additional JS functions here
			  window.fbAsyncInit = function() {
				FB.init({
				  appId      : '1296816550457650', // App ID
				  channelUrl : 'http://localhost/mARs/channel.html', // Channel File
				  status     : true, // check login status
				  cookie     : true, // enable cookies to allow the server to access the session
				  xfbml      : true  // parse XFBML
				});

				// Additional init code here
				FB.getLoginStatus(function(response) {
				  if (response.status === 'connected') {
					// connected
					testAPI();
				  } else if (response.status === 'not_authorized') {
					// not_authorized
					login();
				  } else {
					// not_logged_in
					login();
				  }
				 });

			  };
			  
			  
			function login() {
					FB.login(function(response) {
						if (response.authResponse) {
							console.log(response);
							// connected
						} else {
							// cancelled
						}
					}, {scope: 'user_location,friends_location,friends_online_presence,user_status,user_checkins,friends_status '});
			}
			
			
			function testAPI() {
				console.log('Welcome!  Fetching your information.... ');
				FB.api('me', function(response) {
					console.log('Good to see you, ' + response.name + '.');
				});
				
				/*FB.api('559348503/checkins', function(response) {
					//console.log(response.data);
					if(response.data) {
						$.each(response.data,function(index,checkIn) {
							console.log(checkIn.from.name+": "+checkIn.place.location.latitude+", "+checkIn.place.location.longitude);
							//console.log(friend.name + ' has id:' + friend.id);
						});
					} else {
						alert("Error!");
					}
				});*/
				
				var myLocation;
				FB.api('me?fields=location', function(response) {
					console.log(response);
					window.myLocation = response.location.id;
					getFriendsCheckInData();
				});
				
				
				
				
				
				
				
				/*FB.api('/me/checkins', function(response) {
					console.log(response);
				});*/
	
				
				/*FB.api('/search?friends', function(placesResponse){
					console.log(placesResponse);
				});*/
				
				
				FB.api('me/permissions', function (response) {
					//console.log(response.data);                           
				} );
			}
			
			
			
			
			function getFriendsCheckInData() {
			
				console.log(window.myLocation);
				
				var today = new Date().getTime();
			
				FB.api('me/friends?fields=id,name,location', function(response) {
					if(response.data) {
						$.each(response.data,function(index,friend) {
							//console.log(friend);
							if (friend.hasOwnProperty('location')) {
								
								//console.log(friend.name+','+friend.location.id+','+myLocation)
								friendLocation = ''+friend.location.id;
								//console.log(friendLocation == myLocation);
								//console.log(typeof myLocation);
								if(friendLocation == myLocation){
									//console.log('match');
									FB.api(friend.id+'/checkins', function(response) {
										if(response.data) {
											$.each(response.data,function(index,checkIn) {
												
												var checkInDate = Date.parse(checkIn.created_time);
												//console.log(today - checkInDate);
												if((today - checkInDate) <= 7200000){
													console.log(checkIn.from.name+": "+checkIn.place.location.latitude+", "+checkIn.place.location.longitude);
													console.log('https://graph.facebook.com/'+friend.id+'/picture');
												}
												
											});
										} else {
											//alert("Error!");
											console.log(response.error.message);
										}
									});
								}
							}
							
							
						});
					} else {
						//alert("Error!");
						console.log(response.error.message);
					}
				});
			}
			

			  // Load the SDK Asynchronously
			  (function(d){
				 var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
				 if (d.getElementById(id)) {return;}
				 js = d.createElement('script'); js.id = id; js.async = true;
				 js.src = "http://connect.facebook.net/en_US/all.js";
				 ref.parentNode.insertBefore(js, ref);
			   }(document));
			   
			  
			   
			</script>
	
	</body>
</html>
